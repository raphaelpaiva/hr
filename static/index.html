<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O gravador sem cabeÃ§a</title>
    
    <script src="/static/js/tailwind.min.js"></script>
    
    <style type="text/tailwindcss">
        @layer components {
            .state-recording { @apply text-red-600; }
            .state-new { @apply text-yellow-500; }
            .state-stopped { @apply text-green-600; }
            /* Cores para os indicadores de saÃºde */
            .health-green { @apply text-green-400; }
            .health-yellow { @apply text-yellow-400; }
            .health-red { @apply text-red-500 font-bold; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 pt-20">

    <nav class="fixed top-0 left-0 right-0 bg-slate-900 text-white z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <a class="text-xl font-bold tracking-tight" href="#">O Gravador Sem CabeÃ§a</a>
            
            <div class="flex items-center gap-6">
                <div id="systemHealth" class="flex items-center gap-4 border-r border-slate-700 pr-6 text-sm font-mono">
                    <div id="stat-load" title="Carga do Sistema">
                        <span class="text-slate-400 mr-1">ðŸ“Š</span><span class="value">--</span>
                    </div>
                    <div id="stat-mem" title="Uso de MemÃ³ria">
                        <span class="text-slate-400 mr-1">ðŸ§ </span><span class="value">--%</span>
                    </div>
                    <div id="stat-disk" title="EspaÃ§o em Disco">
                        <span class="text-slate-400 mr-1">ðŸ’¾</span><span class="value">--%</span>
                    </div>
                </div>

                <button id="btnShutdown" 
                        onclick="shutdownSystem()"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-sm">
                    Desligar
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8"> 
        <h1 class="text-3xl font-extrabold mb-8 text-slate-800 text-center md:text-left">Painel de Controle</h1>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
            <h3 class="text-xl font-semibold mb-4 text-slate-700">Nova GravaÃ§Ã£o</h3>
            <div class="flex flex-wrap items-center gap-4">
                <select id="deviceSelect" class="flex-1 min-w-[250px] bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <option value="" disabled selected>Carregando dispositivos...</option>
                </select>
                <button id="btnRecord" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg transition-all shadow-sm">
                    Iniciar GravaÃ§Ã£o
                </button>
            </div>
            
            <div class="mt-3 flex items-center">
                <input id="showAllDevices" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                <label for="showAllDevices" class="ml-2 text-sm font-medium text-gray-600 select-none cursor-pointer">Mostrar todos os dispositivos (incluindo hardware interno)</label>
            </div>
            <div id="lastRecordResult" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-100 text-blue-800 font-mono text-sm"></div>
            <p id="statusMsg" class="mt-2 text-sm h-5"></p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-700">GravaÃ§Ãµes Ativas</h3>
                <button onclick="loadRecordings()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm font-semibold py-2 px-4 rounded-lg transition-colors">
                    â†» Atualizar
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table id="recordingsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">AÃ§Ãµes</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Dispositivo</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Criado em</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-700">HistÃ³rico</h3>
                <button onclick="loadHistory()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm font-semibold py-2 px-4 rounded-lg transition-colors">
                    â†» Atualizar
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table id="historyTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Download</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Dispositivo</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">ModificaÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div> 

    <script>
        const API_BASE = '/api/v1';
        let allDevices = []; // Armazena a lista completa vinda do servidor

        // LÃ³gica de SaÃºde do Sistema
        function getHealthColorClass(value) {
            if (value < 75) return 'health-green';
            if (value < 90) return 'health-yellow';
            return 'health-red';
        }

        async function updateHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (!response.ok) return;
                const data = await response.json();

                const loadEl = document.querySelector('#stat-load .value');
                loadEl.textContent = data.load.toFixed(2);
                loadEl.className = 'value ' + getHealthColorClass(data.load * 10);

                const memEl = document.querySelector('#stat-mem .value');
                memEl.textContent = data.mem_usage.toFixed(1) + '%';
                memEl.className = 'value ' + getHealthColorClass(data.mem_usage);

                const diskEl = document.querySelector('#stat-disk .value');
                diskEl.textContent = data.disk_usage.toFixed(1) + '%';
                diskEl.className = 'value ' + getHealthColorClass(data.disk_usage);

            } catch (error) {
                console.error('Erro ao buscar saÃºde do sistema:', error);
            }
        }

        setInterval(updateHealth, 60000);
        updateHealth();

        const select = document.getElementById('deviceSelect');
        const btnRecord = document.getElementById('btnRecord');
        const statusMsg = document.getElementById('statusMsg');
        const lastRecordResult = document.getElementById('lastRecordResult');
        const tableBodyRecordings = document.querySelector('#recordingsTable tbody');
        const tableBodyHistory = document.querySelector('#historyTable tbody');
        const showAllCheckbox = document.getElementById('showAllDevices');

        const STATE_ICONS = {
            'recording': '<span class="text-lg leading-none state-recording">ðŸ”´</span>',
            'new': '<span class="text-lg leading-none state-new">ðŸŸ¡</span>',
            'stopped': '<span class="text-lg leading-none state-stopped">âœ…</span>'
        };

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp * 1000); 
            return date.toLocaleString('pt-BR', { weekday: 'short', month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        async function shutdownSystem() {
            if (!confirm("Desligar o sistema agora?")) return;
            try { await fetch(`${API_BASE}/shutdown`, { method: 'POST' }); } 
            catch (e) { alert('Comando enviado.'); }
        }

        // --- Nova LÃ³gica de Dispositivos ---

        function renderDevices() {
            const showAll = showAllCheckbox.checked;
            
            // Limpa o select mantendo apenas o placeholder
            select.innerHTML = '<option value="" disabled selected>Selecione um dispositivo</option>';

            // Filtra e ordena
            let filtered = allDevices.filter(d => {
                // Sempre inclui "null"
                if (d.name === 'null') return true;
                // Se "Mostrar todos" estiver marcado, inclui tudo
                if (showAll) return true;
                // Caso contrÃ¡rio, apenas os que comeÃ§am com plughw
                return d.name.startsWith('plughw');
            });

            // OrdenaÃ§Ã£o: "null" primeiro, depois o resto por ordem alfabÃ©tica
            filtered.sort((a, b) => {
                if (a.name === 'null') return -1;
                if (b.name === 'null') return 1;
                return a.name.localeCompare(b.name);
            });

            filtered.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.name; 
                opt.textContent = d.name;
                select.appendChild(opt);
            });
        }

        async function loadDevices() {
            try {
                const res = await fetch(`${API_BASE}/devices`);
                const data = await res.json();
                allDevices = data.devices || [];
                renderDevices();
            } catch (e) { 
                statusMsg.textContent = 'Erro ao carregar dispositivos.'; 
            }
        }

        // Listener para o checkbox de filtro
        showAllCheckbox.addEventListener('change', renderDevices);

        // --- Fim da Nova LÃ³gica ---

        btnRecord.addEventListener('click', async () => {
            if (!select.value) return;
            btnRecord.disabled = true;
            try {
                const res = await fetch(`${API_BASE}/record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: select.value })
                });
                if (res.ok) {
                    const d = await res.json();
                    lastRecordResult.innerHTML = `GravaÃ§Ã£o <strong>${d.id.substring(0,8)}</strong> iniciada.`;
                    lastRecordResult.classList.remove('hidden');
                    loadRecordings();
                }
            } finally { btnRecord.disabled = false; }
        });

        function createTableRow(rec, isHistory = false) {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50 transition-colors";

            const tdAction = tr.insertCell();
            tdAction.className = 'px-4 py-3 flex justify-center items-center gap-2'; 

            const link = document.createElement('a');
            link.href = `/api/v1/result/${rec.id}`;
            link.className = 'w-9 h-9 flex items-center justify-center bg-cyan-50 text-cyan-600 rounded-lg border border-cyan-100 hover:bg-cyan-100';
            link.innerHTML = 'â¤“';
            tdAction.appendChild(link);
            
            if (!isHistory) {
                const btnStop = document.createElement('button');
                btnStop.innerHTML = 'â¹';
                if (rec.state === 'recording') {
                    btnStop.className = 'w-9 h-9 flex items-center justify-center bg-red-50 text-red-600 rounded-lg border border-red-100 hover:bg-red-100';
                    btnStop.onclick = () => stopRecording(rec.id);
                } else {
                    btnStop.className = 'w-9 h-9 flex items-center justify-center bg-gray-50 text-gray-400 rounded-lg cursor-not-allowed';
                }
                tdAction.appendChild(btnStop);
            }

            tr.insertCell().innerHTML = `<span class="px-4 py-3 text-sm font-mono text-gray-500">${rec.id.substring(0, 8)}</span>`;
            tr.insertCell().innerHTML = `<span class="px-4 py-3 text-sm font-medium">${rec.device_name}</span>`;
            tr.insertCell().innerHTML = `<span class="px-4 py-3 text-sm">${STATE_ICONS[rec.state] || rec.state}</span>`;
            tr.insertCell().innerHTML = `<span class="px-4 py-3 text-sm text-gray-400">${formatTimestamp(isHistory ? rec.last_modification : rec.created_at)}</span>`;
            
            return tr;
        }

        async function loadRecordings() {
            try {
                const res = await fetch(`${API_BASE}/recordings`);
                const data = await res.json();
                const list = data.recordings || data;
                tableBodyRecordings.innerHTML = '';
                list.sort((a,b) => b.created_at - a.created_at).forEach(r => tableBodyRecordings.appendChild(createTableRow(r, false)));
            } catch (e) {}
        }
        
        async function loadHistory() {
            try {
                const res = await fetch(`${API_BASE}/history`);
                const data = await res.json();
                const list = data.history || data;
                tableBodyHistory.innerHTML = '';
                list.sort((a,b) => b.created_at - a.created_at).forEach(r => tableBodyHistory.appendChild(createTableRow(r, true)));
            } catch (e) {}
        }

        async function stopRecording(id) {
            await fetch(`${API_BASE}/stop`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id }) 
            });
            loadRecordings(); loadHistory();
        }

        loadDevices(); loadRecordings(); loadHistory();
    </script>
</body>
</html>